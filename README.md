# Telegram Bot on Google Apps Script - Template

This repository is a template for creating a Telegram bot using TypeScript, [grammY](https://grammy.dev/), and Google Sheets, designed to be developed locally and deployed to [Google Apps Script](https://developers.google.com/apps-script).

It provides a modern development workflow that moves away from the online Apps Script editor, allowing you to use your favorite IDE, manage your code with Git, and leverage the power of TypeScript for a more robust and scalable bot.

## Features

-   **Local Development**: Write and manage your bot's code on your local machine.
-   **TypeScript**: Full TypeScript support for type safety and modern language features.
-   **Multi-File Structure**: Organize your code into multiple files and directories for better maintainability.
-   **`esbuild` for Bundling**: A fast and efficient build process that bundles your entire TypeScript project into a single JavaScript file ready for deployment.
-   **`clasp` for Deployment**: Seamless command-line integration for managing and deploying your Google Apps Script project.
-   **`grammY` Framework**: Utilizes the powerful and easy-to-use `grammY` framework for all Telegram Bot API interactions.
-   **Google Sheets as a Database**: Includes a simple integration with Google Sheets for data storage and retrieval.
-   **CI/CD with GitHub Actions**: Automatically builds and deploys your bot on every push to the `main` branch.

## Project Structure

```
.
├── .github/workflows/   # GitHub Actions for CI/CD
│   └── deploy.yml
├── dist/                # Bundled output directory (do not edit manually)
│   ├── .appsscript.json # Google Apps Script manifest
│   └── bundle.js        # The final bundled code (generated by `npm run build`)
├── src/                 # Your TypeScript source code
│   ├── main.ts          # Main bot logic, command handlers, and webhook setup
│   └── sheets.ts        # Functions for interacting with Google Sheets
├── .clasp.json          # `clasp` configuration file
├── .gitignore           # Files and directories to be ignored by Git
├── package.json         # Project dependencies and scripts
└── tsconfig.json        # TypeScript compiler configuration
```

## Prerequisites

Before you begin, make sure you have the following installed:

-   [Node.js and npm](https://nodejs.org/) (v16 or higher recommended)
-   `clasp` (Google's command-line tool for Apps Script)
    ```bash
    npm install -g @google/clasp
    ```

## Setup Instructions

### 1. Create Your Repository

Click the "Use this template" button at the top of this page to create a new repository from this template. Clone your new repository to your local machine.

```bash
git clone https://github.com/YOUR_USERNAME/YOUR_REPOSITORY_NAME.git
cd YOUR_REPOSITORY_NAME
```

### 2. Install Dependencies

Install the project dependencies using npm.

```bash
npm install
```

### 3. Log in to `clasp`

Authenticate `clasp` with your Google account. This will allow you to manage your Apps Script projects from the command line.

```bash
clasp login
```

### 4. Create a Google Apps Script Project

Create a new, standalone Google Apps Script project. This command will create a new script in your Google Drive and automatically update the `scriptId` in your `.clasp.json` file.

```bash
clasp create --type standalone --title "My Telegram Bot"
```
**Important**: This will create a new Google Apps Script project. You must also link this script to a Google Cloud Platform (GCP) project to use it. When prompted in the Apps Script editor, create or link a standard GCP project.

### 5. Create a Google Sheet

Create a new Google Sheet in your Google Drive. This sheet will be used as the database for your bot. You can name the sheet inside the document whatever you like; the script will handle it.

### 6. Configure Script Properties

You need to set up two script properties for your bot to function correctly: the Telegram bot token and the name of the sheet you want to use.

1.  Open your Google Apps Script project by running `clasp open`.
2.  Navigate to **Project Settings** (the gear icon ⚙️ on the left).
3.  Under **Script Properties**, click **Add script property**.
4.  Add the following two properties:
    -   **Property Name**: `BOT_TOKEN`
        **Value**: Your bot token from Telegram's BotFather.
    -   **Property Name**: `SHEET_NAME`
        **Value**: The name of the tab in your Google Sheet you want to use (e.g., `Sheet1` or `Database`). The script will create a sheet with this name if it doesn't exist.

## Development Workflow

All your bot's logic is located in the `src` directory.

-   `src/main.ts`: This is the main entry point. Add your `grammY` command handlers and bot logic here.
-   `src/sheets.ts`: This file contains the functions for reading from and writing to your Google Sheet.

After making changes to your code, you can build the project using:

```bash
npm run build
```

This command uses `esbuild` to bundle all your TypeScript code into a single file: `dist/bundle.js`.

## Deployment

### Manual Deployment

To deploy your bot to Google Apps Script, run:

```bash
npm run deploy
```

This command will first build your project and then push the contents of the `dist` directory to your Apps Script project.

### Setting the Webhook (First-Time Setup)

After your first deployment, you need to tell Telegram where to send bot updates.

1.  In the Apps Script editor, click **Deploy** > **New deployment**.
2.  Select **Web app** as the deployment type.
3.  Configure the web app:
    -   **Description**: `Initial deployment`
    -   **Execute as**: `Me (your@email.com)`
    -   **Who has access**: `Anyone`
4.  Click **Deploy**. This will give you a **Web app URL**. Copy this URL.
5.  In the Apps Script editor, select the `setWebhook` function from the function dropdown list and click **Run**. This will register your web app URL with Telegram.

Your bot is now live! Any future deployments using `npm run deploy` will update the existing deployment, so you don't need to repeat the "New deployment" step unless you change the web app's configuration.

### Automated Deployment (CI/CD)

This template includes a GitHub Actions workflow in `.github/workflows/deploy.yml` that automates the deployment process.

**How it works**:
-   On every push to the `main` branch, the workflow will automatically run `npm install`, `npm run build`, and `clasp push`.

**Setup**:
To enable this, you need to provide your `clasp` credentials to GitHub Actions as secrets.

1.  Find your `.clasprc.json` file. This file contains your `clasp` credentials and is typically located in your home directory (`~/.clasprc.json`).
2.  In your GitHub repository, go to **Settings** > **Secrets and variables** > **Actions**.
3.  Create the following three repository secrets:
    -   `CLASP_SCRIPT_ID`: The ID of your Google Apps Script project (from `.clasp.json`).
    -   `CLASP_ACCESS_TOKEN`: The `access_token` from your `.clasprc.json` file.
    -   `CLASP_REFRESH_TOKEN`: The `refresh_token` from your `.clasprc.json` file.

Once these secrets are set, any push to `main` will automatically deploy your bot.

## A Note on Free Deployment

Using Google Apps Script as a hosting platform is **free**, subject to Google's quotas and limitations. GitHub Actions also provides a generous free tier for public and private repositories, making the entire development and deployment pipeline free for most use cases.
